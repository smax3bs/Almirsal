<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المرسال المتطور - نظام الدردشة التفاعلي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* ثيمات ملونة */
        :root {
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .theme-blue {
            --primary-color: #3b82f6;
            --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .theme-green {
            --primary-color: #10b981;
            --primary-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .theme-purple {
            --primary-color: #8b5cf6;
            --primary-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .theme-pink {
            --primary-color: #ec4899;
            --primary-gradient: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        }
        
        .theme-orange {
            --primary-color: #f59e0b;
            --primary-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .gradient-bg {
            background: var(--primary-gradient);
            min-height: 100vh;
        }
        
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 90vh;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }
        
        .sidebar {
            background: rgba(255, 255, 255, 0.9);
            border-left: 1px solid #e2e8f0;
            width: 300px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .chat-header {
            padding: 16px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .message-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
            min-height: 0;
        }
        
        .input-area {
            padding: 16px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .message-input {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 12px 16px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.4;
            max-height: 120px;
            min-height: 44px;
            transition: all 0.3s ease;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .file-btn, .send-btn {
            width: 34px;
            height: 34px;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .file-btn {
            background: #f1f5f9;
            color: #64748b;
        }
        
        .file-btn:hover {
            background: #e2e8f0;
            transform: scale(1.1);
        }
        
        .send-btn {
            background: var(--primary-gradient);
            color: white;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            animation: slideIn 0.3s ease;
            position: relative;
        }
        
        .message.sent {
            flex-direction: row-reverse;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        /* نظام النجوم */
        .star-rating {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-top: 8px;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message.sent .star-rating {
            background: rgba(255, 255, 255, 0.2);
        }

        .star-rating:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }

        .message.sent .star-rating:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .star {
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .star:hover {
            transform: scale(1.3);
            filter: drop-shadow(0 0 5px gold);
        }

        .star.filled {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .star.empty {
            color: #ddd;
        }

        .message.sent .star.empty {
            color: rgba(255, 255, 255, 0.5);
        }

        .rating-popup {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 20px;
            padding: 10px 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 5px;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            border: 2px solid #ffd700;
        }

        .rating-popup.show {
            opacity: 1;
            pointer-events: all;
            transform: translateX(-50%) translateY(-10px);
        }

        .rating-popup .star {
            font-size: 24px;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .rating-popup .star:hover {
            background: #fff3cd;
            transform: scale(1.2) rotate(15deg);
        }

        .rating-count {
            font-size: 11px;
            color: #666;
            margin-right: 5px;
            font-weight: 500;
        }

        .message.sent .rating-count {
            color: rgba(255, 255, 255, 0.8);
        }

        /* تأثيرات النجوم المتحركة */
        .star-burst {
            position: absolute;
            pointer-events: none;
            font-size: 20px;
            z-index: 1001;
            animation: starBurst 1s ease-out forwards;
        }

        @keyframes starBurst {
            0% {
                opacity: 1;
                transform: scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.5) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(2) rotate(360deg) translateY(-50px);
            }
        }

        .rating-celebration {
            animation: ratingCelebration 0.8s ease-in-out;
        }

        @keyframes ratingCelebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1) rotate(5deg); }
            50% { transform: scale(1.2) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(3deg); }
        }
        
        .message.received .message-bubble {
            background: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .message.sent .message-bubble {
            background: var(--primary-gradient);
            color: white;
            border-bottom-left-radius: 4px;
        }

        .contact-item {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        
        .contact-item:hover {
            background: #f8fafc;
            transform: translateX(-5px);
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }
        
        .contact-item.active {
            background: var(--primary-gradient);
            color: white;
            transform: translateX(-10px);
            box-shadow: 10px 0 20px rgba(102, 126, 234, 0.3);
        }
        
        .avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 22px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }
        
        .online-indicator {
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid white;
            position: absolute;
            bottom: 2px;
            left: 2px;
            animation: pulse 2s infinite;
        }

        .search-bar {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .search-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #64748b;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }
        
        .tab-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* تأثيرات الرسائل التفاعلية */
        .interactive-message {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: visible;
        }

        .interactive-message:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .message-bubble.interactive {
            position: relative;
            overflow: visible;
        }

        /* تأثيرات الضحك */
        .laugh-effect {
            animation: laughShake 0.6s ease-in-out;
        }

        @keyframes laughShake {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-2deg) scale(1.05); }
            50% { transform: rotate(2deg) scale(1.1); }
            75% { transform: rotate(-1deg) scale(1.05); }
        }

        /* تأثيرات الحب */
        .love-effect {
            animation: loveFloat 1s ease-in-out;
        }

        @keyframes loveFloat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1) translateY(-5px); }
            100% { transform: scale(1); }
        }

        /* تأثيرات الغضب */
        .angry-effect {
            animation: angryShake 0.5s ease-in-out;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52) !important;
        }

        @keyframes angryShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        /* تأثيرات الحزن */
        .sad-effect {
            animation: sadDrop 1s ease-in-out;
            filter: blur(1px);
        }

        @keyframes sadDrop {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(5px); opacity: 0.7; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* تأثيرات الإعجاب */
        .wow-effect {
            animation: wowPulse 0.8s ease-in-out;
        }

        @keyframes wowPulse {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1.2); }
            75% { transform: scale(1.1); }
        }

        /* تأثيرات الاحتفال */
        .party-effect {
            animation: partyBounce 1s ease-in-out;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7) !important;
            background-size: 300% 300% !important;
            animation: partyBounce 1s ease-in-out, partyColors 2s ease-in-out infinite !important;
        }

        @keyframes partyBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(2deg); }
            50% { transform: translateY(-15px) rotate(-2deg); }
            75% { transform: translateY(-5px) rotate(1deg); }
        }

        @keyframes partyColors {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* تأثيرات النوم */
        .sleep-effect {
            animation: sleepSway 2s ease-in-out infinite;
            opacity: 0.7;
        }

        @keyframes sleepSway {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            75% { transform: rotate(-1deg); }
        }

        /* تأثيرات الطعام */
        .food-effect {
            animation: foodYum 0.8s ease-in-out;
        }

        @keyframes foodYum {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15) rotate(5deg); }
        }

        /* فقاعات التفاعل */
        .reaction-bubble {
            position: absolute;
            pointer-events: none;
            font-size: 20px;
            z-index: 1000;
            animation: bubbleFloat 2s ease-out forwards;
        }

        @keyframes bubbleFloat {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translateY(-10px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(1.2);
            }
        }

        /* تأثيرات الكلمات الخاصة */
        .word-highlight {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            animation: wordGlow 1s ease-in-out;
        }

        @keyframes wordGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }

        /* تأثيرات الاهتزاز */
        .vibrate-effect {
            animation: vibrate 0.3s ease-in-out;
        }

        @keyframes vibrate {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-2px); }
            20% { transform: translateX(2px); }
            30% { transform: translateX(-2px); }
            40% { transform: translateX(2px); }
            50% { transform: translateX(-2px); }
            60% { transform: translateX(2px); }
            70% { transform: translateX(-2px); }
            80% { transform: translateX(2px); }
            90% { transform: translateX(-2px); }
        }

        /* === نظام الهدايا === */
        .gift-menu {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            border: 2px solid var(--primary-color);
            min-width: 200px;
        }

        .gift-menu.show {
            display: block;
            animation: giftMenuSlide 0.3s ease-out;
        }

        @keyframes giftMenuSlide {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .gift-menu h3 {
            text-align: center;
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 16px;
            font-weight: bold;
        }

        .gift-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .gift-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            border: 2px solid #f1f5f9;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .gift-option:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .gift-option .gift-emoji {
            font-size: 30px;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .gift-option:hover .gift-emoji {
            transform: scale(1.2) rotate(10deg);
        }

        .gift-option .gift-name {
            font-size: 12px;
            color: #666;
            text-align: center;
            font-weight: 500;
        }

        .gift-option:hover .gift-name {
            color: var(--primary-color);
        }

        /* رسائل الهدايا */
        .gift-message {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1);
            background-size: 200% 200%;
            animation: giftGradient 3s ease infinite;
            color: white;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            max-width: 250px;
            margin: 10px auto;
        }

        @keyframes giftGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .gift-message::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: giftShine 2s ease-in-out infinite;
        }

        @keyframes giftShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .gift-content {
            position: relative;
            z-index: 2;
        }

        .gift-emoji-large {
            font-size: 50px;
            display: block;
            margin-bottom: 10px;
            animation: giftBounce 1s ease-in-out infinite alternate;
        }

        @keyframes giftBounce {
            0% { transform: scale(1) rotate(0deg); }
            100% { transform: scale(1.1) rotate(5deg); }
        }

        .gift-text {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .gift-sender {
            font-size: 12px;
            opacity: 0.9;
            font-style: italic;
        }

        /* تأثيرات فتح الهدية */
        .gift-opening {
            animation: giftOpen 2s ease-in-out;
        }

        @keyframes giftOpen {
            0% {
                transform: scale(0.5) rotate(0deg);
                opacity: 0;
            }
            25% {
                transform: scale(0.8) rotate(10deg);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.2) rotate(-5deg);
                opacity: 1;
            }
            75% {
                transform: scale(0.9) rotate(3deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* جزيئات الهدية */
        .gift-particle {
            position: absolute;
            pointer-events: none;
            z-index: 1001;
            font-size: 20px;
            animation: giftParticleFloat 3s ease-out forwards;
        }

        @keyframes giftParticleFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-30px) scale(1) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(1.5) rotate(360deg);
            }
        }

        /* تأثيرات الهدايا المختلفة */
        .gift-rose {
            background: linear-gradient(135deg, #ff6b9d, #c44569);
        }

        .gift-chocolate {
            background: linear-gradient(135deg, #8b4513, #d2691e);
        }

        .gift-star {
            background: linear-gradient(135deg, #ffd700, #ffb347);
        }

        .gift-heart {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }

        .gift-diamond {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }

        .gift-crown {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }

        /* تأثير النبضات للهدايا */
        .gift-pulse {
            animation: giftPulse 1.5s ease-in-out infinite;
        }

        @keyframes giftPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(255, 107, 107, 0);
            }
        }

        /* إشعارات الهدايا */
        .gift-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            text-align: center;
            border: 3px solid var(--primary-color);
            animation: giftNotificationShow 0.5s ease-out;
        }

        @keyframes giftNotificationShow {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .gift-notification .gift-emoji-huge {
            font-size: 80px;
            margin-bottom: 15px;
            animation: giftNotificationBounce 1s ease-in-out infinite;
        }

        @keyframes giftNotificationBounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(10deg); }
        }

        .gift-notification h2 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .gift-notification p {
            color: #666;
            margin: 0 0 20px 0;
            font-size: 16px;
        }

        .gift-notification button {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .gift-notification button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* === نظام الذكريات اليومية === */
        .memory-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s ease;
        }

        .memory-popup.show {
            opacity: 1;
            pointer-events: all;
        }

        .memory-card {
            background: white;
            border-radius: 25px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            transform: scale(0.8) translateY(50px);
            transition: all 0.5s ease;
            border: 3px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }

        .memory-popup.show .memory-card {
            transform: scale(1) translateY(0);
        }

        .memory-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: memoryShine 3s ease-in-out infinite;
        }

        @keyframes memoryShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .memory-header {
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }

        .memory-header h2 {
            color: var(--primary-color);
            font-size: 28px;
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        .memory-date {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .memory-question {
            font-size: 20px;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .mood-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mood-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 3px solid #f1f5f9;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            min-width: 80px;
        }

        .mood-option:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .mood-option.selected {
            border-color: var(--primary-color);
            background: var(--primary-gradient);
            color: white;
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .mood-emoji {
            font-size: 40px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .mood-option:hover .mood-emoji {
            transform: scale(1.2) rotate(10deg);
        }

        .mood-option.selected .mood-emoji {
            transform: scale(1.3) rotate(15deg);
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }

        .mood-label {
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }

        .memory-textarea {
            width: 100%;
            min-height: 120px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 15px;
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
            transition: all 0.3s ease;
            margin-bottom: 25px;
            background: #fafafa;
        }

        .memory-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .memory-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .memory-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .memory-btn.primary {
            background: var(--primary-gradient);
            color: white;
        }

        .memory-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .memory-btn.secondary {
            background: #f1f5f9;
            color: #64748b;
        }

        .memory-btn.secondary:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        /* صفحة الذكريات */
        .memories-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            z-index: 2500;
            display: none;
            overflow-y: auto;
        }

        .memories-page.show {
            display: block;
            animation: memoriesPageSlide 0.5s ease-out;
        }

        @keyframes memoriesPageSlide {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .memories-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .memories-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .memories-header h1 {
            color: var(--primary-color);
            font-size: 32px;
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        .memories-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .memory-stat {
            text-align: center;
        }

        .memory-stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .memory-stat-label {
            font-size: 14px;
            color: #666;
        }

        .memories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .memory-item {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .memory-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .memory-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .memory-item-date {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 16px;
        }

        .memory-item-mood {
            font-size: 30px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .memory-item-text {
            color: #333;
            line-height: 1.6;
            font-size: 15px;
            margin-bottom: 15px;
        }

        .memory-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #666;
        }

        .memory-actions-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .close-memories-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .close-memories-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* تأثيرات الذكريات */
        .memory-celebration {
            animation: memoryCelebration 1s ease-in-out;
        }

        @keyframes memoryCelebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(2deg); }
            50% { transform: scale(1.1) rotate(-2deg); }
            75% { transform: scale(1.05) rotate(1deg); }
        }

        .memory-particle {
            position: absolute;
            pointer-events: none;
            z-index: 3001;
            font-size: 20px;
            animation: memoryParticleFloat 3s ease-out forwards;
        }

        @keyframes memoryParticleFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-40px) scale(1) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(1.5) rotate(360deg);
            }
        }

        /* استجابة للشاشات الصغيرة */
        @media (max-width: 768px) {
            .memory-card {
                padding: 25px;
                margin: 20px;
            }
            
            .mood-selector {
                gap: 10px;
            }
            
            .mood-option {
                min-width: 60px;
                padding: 10px;
            }
            
            .mood-emoji {
                font-size: 30px;
            }
            
            .memories-grid {
                grid-template-columns: 1fr;
            }
        }

        /* === أنيميشن الإيموجي الطائرة === */
        .flying-emoji {
            position: fixed;
            font-size: 40px;
            pointer-events: none;
            z-index: 1000;
            user-select: none;
        }

        /* أنواع الحركات المختلفة */
        .fly-straight {
            animation: flyingStraight 4s ease-out forwards;
        }

        .fly-bounce {
            animation: flyingBounce 5s ease-out forwards;
        }

        .fly-spiral {
            animation: flyingSpiral 6s ease-out forwards;
        }

        .fly-zigzag {
            animation: flyingZigzag 5s ease-out forwards;
        }

        .fly-float {
            animation: flyingFloat 7s ease-out forwards;
        }

        /* تأثيرات الذيل للإيموجي */
        .emoji-trail::after {
            content: attr(data-emoji);
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0.5;
            font-size: 30px;
            animation: trailFade 1s ease-out infinite;
        }

        /* أنواع الإيموجي المختلفة */
        .emoji-laugh {
            filter: drop-shadow(0 0 10px rgba(255, 193, 7, 0.6));
        }

        .emoji-heart {
            filter: drop-shadow(0 0 10px rgba(255, 20, 147, 0.6));
        }

        .emoji-fire {
            filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.6));
        }

        .emoji-star {
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
        }

        .emoji-party {
            filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.6));
        }

        /* حركات الطيران */
        @keyframes flyingStraight {
            0% {
                opacity: 1;
                transform: scale(0.5) rotate(0deg);
            }
            20% {
                opacity: 1;
                transform: scale(1) rotate(45deg);
            }
            100% {
                opacity: 0;
                transform: scale(1.5) rotate(360deg) translateX(100vw) translateY(-50vh);
            }
        }

        @keyframes flyingBounce {
            0% {
                opacity: 1;
                transform: scale(0.5) translateY(0);
            }
            10% {
                transform: scale(1) translateY(-30px);
            }
            20% {
                transform: scale(1.1) translateY(0);
            }
            30% {
                transform: scale(1) translateY(-20px);
            }
            40% {
                transform: scale(1.05) translateY(0);
            }
            50% {
                transform: scale(1) translateY(-15px);
            }
            60% {
                transform: scale(1.02) translateY(0);
            }
            70% {
                transform: scale(1) translateY(-10px);
            }
            80% {
                transform: scale(1.01) translateY(0);
            }
            90% {
                transform: scale(1) translateY(-5px);
            }
            100% {
                opacity: 0;
                transform: scale(1.5) translateY(-100vh) translateX(50vw);
            }
        }

        @keyframes flyingSpiral {
            0% {
                opacity: 1;
                transform: scale(0.5) rotate(0deg) translateX(0) translateY(0);
            }
            25% {
                opacity: 1;
                transform: scale(1) rotate(90deg) translateX(100px) translateY(-100px);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) rotate(180deg) translateX(0) translateY(-200px);
            }
            75% {
                opacity: 1;
                transform: scale(1) rotate(270deg) translateX(-100px) translateY(-300px);
            }
            100% {
                opacity: 0;
                transform: scale(1.5) rotate(360deg) translateX(0) translateY(-400px);
            }
        }

        @keyframes flyingZigzag {
            0% {
                opacity: 1;
                transform: scale(0.5) translateX(0) translateY(0);
            }
            12.5% {
                transform: scale(0.8) translateX(50px) translateY(-50px);
            }
            25% {
                transform: scale(1) translateX(-30px) translateY(-100px);
            }
            37.5% {
                transform: scale(1.1) translateX(70px) translateY(-150px);
            }
            50% {
                transform: scale(1) translateX(-50px) translateY(-200px);
            }
            62.5% {
                transform: scale(1.05) translateX(80px) translateY(-250px);
            }
            75% {
                transform: scale(1) translateX(-40px) translateY(-300px);
            }
            87.5% {
                transform: scale(1.02) translateX(60px) translateY(-350px);
            }
            100% {
                opacity: 0;
                transform: scale(1.5) translateX(0) translateY(-400px);
            }
        }

        @keyframes flyingFloat {
            0% {
                opacity: 1;
                transform: scale(0.5) translateY(0) rotate(0deg);
            }
            10% {
                transform: scale(0.7) translateY(-20px) rotate(18deg);
            }
            20% {
                transform: scale(0.9) translateY(-35px) rotate(36deg);
            }
            30% {
                transform: scale(1) translateY(-45px) rotate(54deg);
            }
            40% {
                transform: scale(1.1) translateY(-50px) rotate(72deg);
            }
            50% {
                transform: scale(1.2) translateY(-60px) rotate(90deg);
            }
            60% {
                transform: scale(1.1) translateY(-80px) rotate(108deg);
            }
            70% {
                transform: scale(1) translateY(-120px) rotate(126deg);
            }
            80% {
                transform: scale(0.9) translateY(-180px) rotate(144deg);
            }
            90% {
                transform: scale(0.8) translateY(-260px) rotate(162deg);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) translateY(-400px) rotate(180deg);
            }
        }

        @keyframes trailFade {
            0% {
                opacity: 0.5;
                transform: scale(1);
            }
            50% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
            }
        }
    </style>
</head>
<body class="gradient-bg">
    <!-- واجهة الدردشة الرئيسية -->
    <div id="chatScreen" class="min-h-screen p-4 flex items-center justify-center">
        <div class="chat-container max-w-7xl w-full mx-auto">
            <!-- الشريط الجانبي -->
            <div class="sidebar">
                <!-- شريط البحث -->
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="البحث في المحادثات..." onkeyup="searchContacts(this.value)">
                </div>
                
                <!-- تبويبات الدردشة -->
                <div class="flex border-b border-gray-200">
                    <button class="tab-btn active" onclick="switchTab('contacts')" data-tab="contacts">
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        الأشخاص
                    </button>
                    <button class="tab-btn" onclick="switchTab('groups')" data-tab="groups">
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        الجروبات
                    </button>
                </div>
                
                <!-- قائمة جهات الاتصال -->
                <div id="contactsList" class="flex-1 overflow-y-auto tab-content active" data-content="contacts">
                    <!-- سيتم ملؤها بـ JavaScript -->
                </div>
                
                <!-- قائمة الجروبات -->
                <div id="groupsList" class="flex-1 overflow-y-auto tab-content" data-content="groups">
                    <div class="p-4 text-center text-gray-500">
                        <div class="text-4xl mb-2">👥</div>
                        <p>لا توجد جروبات بعد</p>
                    </div>
                </div>
                
                <!-- معلومات المستخدم -->
                <div class="p-4 border-t border-gray-200">
                    <div class="flex items-center gap-3">
                        <div class="avatar relative cursor-pointer" title="الملف الشخصي">
                            <span id="userAvatar">A</span>
                            <div class="online-indicator" id="userOnlineIndicator"></div>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold" id="currentUser">المستخدم</div>
                            <div class="text-sm text-gray-500" id="currentUserStatus">متصل</div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="showDailyMemoryPrompt()" class="text-purple-500 hover:text-purple-700 transition-all hover:scale-110" title="ذكرياتي اليومية">
                                📝
                            </button>
                            <button onclick="showNotification('الإعدادات قيد التطوير! ⚙️')" class="text-blue-500 hover:text-blue-700 transition-all hover:scale-110" title="الإعدادات">
                                ⚙️
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- منطقة الدردشة -->
            <div class="chat-area">
                <!-- رأس الدردشة -->
                <div class="chat-header">
                    <div class="avatar relative" style="width: 60px; height: 60px; font-size: 24px;">
                        <span id="chatAvatar">؟</span>
                        <div class="online-indicator" id="chatOnlineIndicator"></div>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-lg" id="chatName">اختر محادثة</div>
                        <div class="text-sm text-gray-500" id="chatStatus">للبدء في الدردشة</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showMemoriesPage()" class="p-2 hover:bg-gray-100 rounded-full transition-all" title="الذكريات اليومية">
                            📖
                        </button>
                        <button onclick="showNotification('المكالمات قيد التطوير! 📞')" class="p-2 hover:bg-gray-100 rounded-full transition-all" title="مكالمة صوتية">
                            📞
                        </button>
                        <button onclick="showNotification('المكالمات المرئية قيد التطوير! 📹')" class="p-2 hover:bg-gray-100 rounded-full transition-all" title="مكالمة مرئية">
                            📹
                        </button>
                    </div>
                </div>
                
                <!-- منطقة الرسائل -->
                <div class="message-container" id="messageContainer">
                    <div class="text-center text-gray-500 mt-20">
                        <div class="text-6xl mb-4">💬</div>
                        <h3 class="text-xl font-semibold mb-2">مرحباً بك في المرسال المتطور!</h3>
                        <p>اختر محادثة من الشريط الجانبي للبدء</p>
                        <div class="mt-4 text-sm">
                            <p>💡 نصيحة: اضغط على أي رسالة تحتوي على كلمات مثل "ههههه" أو "أحبك" لترى السحر!</p>
                        </div>
                    </div>
                </div>
                
                <!-- منطقة الكتابة -->
                <div class="input-area">
                    <button class="file-btn" onclick="showNotification('الملفات قيد التطوير! 📎')" title="إرفاق ملف">
                        📎
                    </button>
                    <button class="file-btn" onclick="addInteractiveTestMessage()" title="رسالة تفاعلية">
                        💌
                    </button>
                    <button class="file-btn" onclick="launchRandomEmoji()" title="إيموجي طائرة">
                        🚀
                    </button>
                    <button class="file-btn" onclick="launchEmojiStorm('🎉', 8)" title="عاصفة إيموجي">
                        🌪️
                    </button>
                    <button class="file-btn" onclick="showGiftMenu()" title="إرسال هدية">
                        🎁
                    </button>
                    <textarea class="message-input" id="messageInput" placeholder="اكتب رسالتك هنا..." rows="1" onkeypress="handleKeyPress(event)" oninput="adjustTextareaHeight(this)"></textarea>
                    <button class="send-btn" onclick="sendMessage()" title="إرسال">
                        ➤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- قائمة الهدايا -->
    <div id="giftMenu" class="gift-menu">
        <h3>🎁 اختر هدية</h3>
        <div class="gift-options">
            <div class="gift-option" onclick="sendGift('🌹', 'وردة', 'rose')">
                <div class="gift-emoji">🌹</div>
                <div class="gift-name">وردة</div>
            </div>
            <div class="gift-option" onclick="sendGift('🍫', 'شوكولاتة', 'chocolate')">
                <div class="gift-emoji">🍫</div>
                <div class="gift-name">شوكولاتة</div>
            </div>
            <div class="gift-option" onclick="sendGift('✨', 'نجمة', 'star')">
                <div class="gift-emoji">✨</div>
                <div class="gift-name">نجمة</div>
            </div>
            <div class="gift-option" onclick="sendGift('❤️', 'قلب', 'heart')">
                <div class="gift-emoji">❤️</div>
                <div class="gift-name">قلب</div>
            </div>
            <div class="gift-option" onclick="sendGift('💎', 'ماسة', 'diamond')">
                <div class="gift-emoji">💎</div>
                <div class="gift-name">ماسة</div>
            </div>
            <div class="gift-option" onclick="sendGift('👑', 'تاج', 'crown')">
                <div class="gift-emoji">👑</div>
                <div class="gift-name">تاج</div>
            </div>
        </div>
    </div>

    <!-- نافذة الذكريات اليومية -->
    <div id="memoryPopup" class="memory-popup">
        <div class="memory-card">
            <div class="memory-header">
                <h2>📖 ذكرياتي اليومية</h2>
                <div class="memory-date" id="memoryDate"></div>
                <div class="memory-question">كيف كان يومك اليوم؟ 😊</div>
            </div>
            
            <div class="mood-selector">
                <div class="mood-option" onclick="selectMood(this, '😊', 'سعيد')">
                    <div class="mood-emoji">😊</div>
                    <div class="mood-label">سعيد</div>
                </div>
                <div class="mood-option" onclick="selectMood(this, '😢', 'حزين')">
                    <div class="mood-emoji">😢</div>
                    <div class="mood-label">حزين</div>
                </div>
                <div class="mood-option" onclick="selectMood(this, '😴', 'متعب')">
                    <div class="mood-emoji">😴</div>
                    <div class="mood-label">متعب</div>
                </div>
                <div class="mood-option" onclick="selectMood(this, '😍', 'متحمس')">
                    <div class="mood-emoji">😍</div>
                    <div class="mood-label">متحمس</div>
                </div>
                <div class="mood-option" onclick="selectMood(this, '😤', 'غاضب')">
                    <div class="mood-emoji">😤</div>
                    <div class="mood-label">غاضب</div>
                </div>
                <div class="mood-option" onclick="selectMood(this, '🤔', 'مفكر')">
                    <div class="mood-emoji">🤔</div>
                    <div class="mood-label">مفكر</div>
                </div>
            </div>
            
            <textarea 
                id="memoryText" 
                class="memory-textarea" 
                placeholder="اكتب عن يومك... ما الذي حدث؟ كيف شعرت؟ ما الذي تعلمته؟ 📝"
            ></textarea>
            
            <div class="memory-actions">
                <button class="memory-btn secondary" onclick="closeMemoryPopup()">
                    تجاهل
                </button>
                <button class="memory-btn primary" onclick="saveMemory()">
                    حفظ الذكرى ✨
                </button>
            </div>
        </div>
    </div>

    <!-- صفحة الذكريات -->
    <div id="memoriesPage" class="memories-page">
        <div class="memories-container">
            <div class="memories-header">
                <h1>📖 ذكرياتي الشخصية</h1>
                <p>مجموعة من اللحظات والمشاعر التي عشتها</p>
                <div class="memories-stats">
                    <div class="memory-stat">
                        <div class="memory-stat-number" id="totalMemories">0</div>
                        <div class="memory-stat-label">ذكرى</div>
                    </div>
                    <div class="memory-stat">
                        <div class="memory-stat-number" id="happyDays">0</div>
                        <div class="memory-stat-label">يوم سعيد</div>
                    </div>
                    <div class="memory-stat">
                        <div class="memory-stat-number" id="currentStreak">0</div>
                        <div class="memory-stat-label">يوم متتالي</div>
                    </div>
                </div>
            </div>
            
            <div id="memoriesGrid" class="memories-grid">
                <!-- سيتم ملؤها بـ JavaScript -->
            </div>
            
            <div class="memory-actions-bar">
                <button class="close-memories-btn" onclick="closeMemoriesPage()">
                    العودة للدردشة 💬
                </button>
            </div>
        </div>
    </div>

    <script>
        // متغيرات عامة
        let currentChat = null;
        let contacts = [
            { id: 1, name: 'أحمد محمد', avatar: 'أ', status: 'online', lastSeen: 'متصل الآن', phone: '+966501234567' },
            { id: 2, name: 'فاطمة علي', avatar: 'ف', status: 'away', lastSeen: 'آخر ظهور منذ 5 دقائق', phone: '+966507654321' },
            { id: 3, name: 'محمد سالم', avatar: 'م', status: 'busy', lastSeen: 'آخر ظهور منذ ساعة', phone: '+966512345678' },
            { id: 4, name: 'نورا أحمد', avatar: 'ن', status: 'online', lastSeen: 'متصلة الآن', phone: '+966598765432' }
        ];
        
        let messages = {};
        let currentUser = { name: 'المستخدم', avatar: 'A', status: 'online' };

        // تحميل جهات الاتصال
        function loadContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';
            
            contacts.forEach((contact, index) => {
                const contactElement = document.createElement('div');
                contactElement.className = 'contact-item';
                contactElement.setAttribute('data-contact-id', contact.id);
                
                const statusEmoji = {
                    'online': '🟢',
                    'away': '🟡',
                    'busy': '🔴',
                    'invisible': '⚫'
                };
                
                contactElement.innerHTML = `
                    <div class="avatar">
                        <span>${contact.avatar}</span>
                        <div class="online-indicator" style="display: ${contact.status === 'online' ? 'block' : 'none'}"></div>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold">${contact.name}</div>
                        <div class="text-sm text-gray-500">${contact.lastSeen}</div>
                    </div>
                    <div class="text-xs text-gray-400">
                        ${statusEmoji[contact.status]}
                    </div>
                `;
                
                // إضافة مستمع الأحداث بطريقة صحيحة
                contactElement.addEventListener('click', function() {
                    openChat(contact);
                });
                
                contactsList.appendChild(contactElement);
            });
        }

        // فتح محادثة
        function openChat(contact) {
            currentChat = contact;
            
            // تحديث رأس الدردشة
            document.getElementById('chatAvatar').textContent = contact.avatar;
            document.getElementById('chatName').textContent = contact.name;
            document.getElementById('chatStatus').textContent = contact.lastSeen;
            document.getElementById('chatOnlineIndicator').style.display = contact.status === 'online' ? 'block' : 'none';
            
            // تحديث الرسائل
            loadMessages(contact.id);
            
            // تحديث الشريط الجانبي
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // البحث عن العنصر الصحيح وتفعيله
            const contactElement = document.querySelector(`[data-contact-id="${contact.id}"]`);
            if (contactElement) {
                contactElement.classList.add('active');
            }
            
            showNotification(`تم فتح محادثة ${contact.name}! 💬`);
        }

        // تحميل الرسائل
        function loadMessages(contactId) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = '';
            
            if (!messages[contactId]) {
                messages[contactId] = [
                    { id: 1, text: 'مرحباً! كيف حالك؟', sent: false, time: '10:30', rating: 0, ratingCount: 0 },
                    { id: 2, text: 'أهلاً وسهلاً! بخير والحمد لله ههههه 😂', sent: true, time: '10:32', rating: 4, ratingCount: 3 },
                    { id: 3, text: 'ما أخبارك؟ أحبك كثيراً ❤️', sent: false, time: '10:33', rating: 5, ratingCount: 2 },
                    { id: 4, text: 'واو! هذا رائع جداً 🤩', sent: true, time: '10:34', rating: 3, ratingCount: 1 },
                    { id: 5, text: 'أنا جائع جداً 🍕', sent: false, time: '10:35', rating: 2, ratingCount: 1 }
                ];
            }
            
            messages[contactId].forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.sent ? 'sent' : 'received'}`;
                messageElement.setAttribute('data-message-id', message.id);
                
                if (message.isGame) {
                    // عرض رسائل الألعاب والمحتوى التفاعلي
                    messageElement.innerHTML = `
                        <div class="message-bubble" style="max-width: 90%; background: ${message.sent ? 'var(--primary-gradient)' : 'white'}; ${message.sent ? 'color: white;' : ''}">
                            ${message.text}
                            <div class="text-xs opacity-70 mt-2">${message.time}</div>
                        </div>
                    `;
                } else {
                    // عرض الرسائل العادية مع التفاعل والنجوم
                    const processedText = makeTextInteractive(message.text);
                    const starRating = createStarRating(message.rating || 0, message.ratingCount || 0, message.id);
                    
                    messageElement.innerHTML = `
                        <div class="message-bubble interactive-message" onclick="handleMessageClick(this, '${message.text.replace(/'/g, "\\'")}')">
                            ${processedText}
                            <div class="text-xs opacity-70 mt-1">${message.time}</div>
                            ${starRating}
                        </div>
                    `;
                }
                
                messageContainer.appendChild(messageElement);
            });
            
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // إنشاء نظام تقييم النجوم
        function createStarRating(currentRating, ratingCount, messageId) {
            const stars = [];
            for (let i = 1; i <= 5; i++) {
                const starClass = i <= currentRating ? 'filled' : 'empty';
                stars.push(`<span class="star ${starClass}" data-rating="${i}">⭐</span>`);
            }
            
            const countText = ratingCount > 0 ? `<span class="rating-count">${ratingCount}</span>` : '';
            
            return `
                <div class="star-rating" onclick="event.stopPropagation(); showRatingPopup(this, ${messageId})" data-message-id="${messageId}">
                    ${countText}${stars.join('')}
                </div>
            `;
        }

        // === وظائف الرسائل التفاعلية ===
        
        // معالجة النص لجعله تفاعلي
        function makeTextInteractive(text) {
            // قاموس الكلمات التفاعلية والتأثيرات المرتبطة بها
            const interactiveWords = {
                // كلمات الضحك
                'ههههه': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'هههه': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'ههه': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'هه': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'لول': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'LOL': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'haha': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'hahaha': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                
                // كلمات الحب
                'أحبك': { effect: 'love', bubbles: ['❤️', '💕', '💖', '💗'] },
                'حبيبي': { effect: 'love', bubbles: ['❤️', '💕', '💖', '💗'] },
                'حبيبتي': { effect: 'love', bubbles: ['❤️', '💕', '💖', '💗'] },
                'عشقك': { effect: 'love', bubbles: ['❤️', '💕', '💖', '💗'] },
                'love': { effect: 'love', bubbles: ['❤️', '💕', '💖', '💗'] },
                
                // كلمات الغضب
                'غاضب': { effect: 'angry', bubbles: ['😡', '🤬', '💢'] },
                'زعلان': { effect: 'angry', bubbles: ['😡', '🤬', '💢'] },
                'مجنون': { effect: 'angry', bubbles: ['😡', '🤬', '💢'] },
                'angry': { effect: 'angry', bubbles: ['😡', '🤬', '💢'] },
                
                // كلمات الحزن
                'حزين': { effect: 'sad', bubbles: ['😢', '😭', '💔'] },
                'sad': { effect: 'sad', bubbles: ['😢', '😭', '💔'] },
                
                // كلمات الإعجاب
                'واو': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'رائع': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'جميل': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'مذهل': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'wow': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'amazing': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                
                // كلمات الاحتفال
                'مبروك': { effect: 'party', bubbles: ['🎉', '🎊', '🥳', '🎈'] },
                'تهانينا': { effect: 'party', bubbles: ['🎉', '🎊', '🥳', '🎈'] },
                'يا هلا': { effect: 'party', bubbles: ['🎉', '🎊', '🥳', '🎈'] },
                'party': { effect: 'party', bubbles: ['🎉', '🎊', '🥳', '🎈'] },
                
                // كلمات النوم
                'نعسان': { effect: 'sleep', bubbles: ['😴', '💤', '🛌'] },
                'نايم': { effect: 'sleep', bubbles: ['😴', '💤', '🛌'] },
                'تعبان': { effect: 'sleep', bubbles: ['😴', '💤', '🛌'] },
                'sleepy': { effect: 'sleep', bubbles: ['😴', '💤', '🛌'] },
                
                // كلمات الطعام
                'جائع': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] },
                'جوعان': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] },
                'طعام': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] },
                'أكل': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] },
                'hungry': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] },
                'food': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] }
            };
            
            let processedText = text;
            
            // البحث عن الكلمات التفاعلية وتمييزها
            Object.keys(interactiveWords).forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                processedText = processedText.replace(regex, `<span class="word-highlight interactive-word" data-word="${word}">${word}</span>`);
            });
            
            return processedText;
        }

        // معالجة النقر على الرسالة
        function handleMessageClick(messageElement, originalText) {
            // البحث عن الكلمات التفاعلية في النص
            const interactiveWords = {
                'ههههه': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'هههه': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'ههه': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'هه': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'لول': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'LOL': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'haha': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'hahaha': { effect: 'laugh', bubbles: ['😂', '🤣', '😆'] },
                'أحبك': { effect: 'love', bubbles: ['❤️', '💕', '💖', '💗'] },
                'حبيبي': { effect: 'love', bubbles: ['❤️', '💕', '💖', '💗'] },
                'حبيبتي': { effect: 'love', bubbles: ['❤️', '💕', '💖', '💗'] },
                'عشقك': { effect: 'love', bubbles: ['❤️', '💕', '💖', '💗'] },
                'love': { effect: 'love', bubbles: ['❤️', '💕', '💖', '💗'] },
                'غاضب': { effect: 'angry', bubbles: ['😡', '🤬', '💢'] },
                'زعلان': { effect: 'angry', bubbles: ['😡', '🤬', '💢'] },
                'مجنون': { effect: 'angry', bubbles: ['😡', '🤬', '💢'] },
                'angry': { effect: 'angry', bubbles: ['😡', '🤬', '💢'] },
                'حزين': { effect: 'sad', bubbles: ['😢', '😭', '💔'] },
                'sad': { effect: 'sad', bubbles: ['😢', '😭', '💔'] },
                'واو': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'رائع': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'جميل': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'مذهل': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'wow': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'amazing': { effect: 'wow', bubbles: ['🤩', '😍', '🔥', '💯'] },
                'مبروك': { effect: 'party', bubbles: ['🎉', '🎊', '🥳', '🎈'] },
                'تهانينا': { effect: 'party', bubbles: ['🎉', '🎊', '🥳', '🎈'] },
                'يا هلا': { effect: 'party', bubbles: ['🎉', '🎊', '🥳', '🎈'] },
                'party': { effect: 'party', bubbles: ['🎉', '🎊', '🥳', '🎈'] },
                'نعسان': { effect: 'sleep', bubbles: ['😴', '💤', '🛌'] },
                'نايم': { effect: 'sleep', bubbles: ['😴', '💤', '🛌'] },
                'تعبان': { effect: 'sleep', bubbles: ['😴', '💤', '🛌'] },
                'sleepy': { effect: 'sleep', bubbles: ['😴', '💤', '🛌'] },
                'جائع': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] },
                'جوعان': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] },
                'طعام': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] },
                'أكل': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] },
                'hungry': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] },
                'food': { effect: 'food', bubbles: ['🍕', '🍔', '🍟', '😋'] }
            };
            
            // البحث عن أول كلمة تفاعلية في النص
            let foundWord = null;
            let foundEffect = null;
            
            Object.keys(interactiveWords).forEach(word => {
                if (originalText.toLowerCase().includes(word.toLowerCase()) && !foundWord) {
                    foundWord = word;
                    foundEffect = interactiveWords[word];
                }
            });
            
            if (foundEffect) {
                // تطبيق التأثير على الرسالة
                applyMessageEffect(messageElement, foundEffect.effect);
                
                // إنشاء فقاعات التفاعل
                createReactionBubbles(messageElement, foundEffect.bubbles);
                
                // تشغيل اهتزاز خفيف (إذا كان متاحاً)
                if (navigator.vibrate) {
                    navigator.vibrate(100);
                }
                
                // إظهار إشعار تفاعلي
                showInteractiveNotification(foundWord, foundEffect.effect);
            } else {
                // تأثير افتراضي للرسائل العادية
                messageElement.classList.add('vibrate-effect');
                setTimeout(() => {
                    messageElement.classList.remove('vibrate-effect');
                }, 300);
                
                // فقاعات عشوائية
                createReactionBubbles(messageElement, ['✨', '💫', '⭐']);
            }
        }

        // تطبيق التأثير على الرسالة
        function applyMessageEffect(messageElement, effectType) {
            // إزالة التأثيرات السابقة
            messageElement.classList.remove('laugh-effect', 'love-effect', 'angry-effect', 'sad-effect', 'wow-effect', 'party-effect', 'sleep-effect', 'food-effect');
            
            // إضافة التأثير الجديد
            messageElement.classList.add(effectType + '-effect');
            
            // إزالة التأثير بعد انتهاء الحركة
            setTimeout(() => {
                messageElement.classList.remove(effectType + '-effect');
            }, effectType === 'party' ? 3000 : effectType === 'sleep' ? 2000 : 1000);
        }

        // إنشاء فقاعات التفاعل
        function createReactionBubbles(messageElement, bubbleEmojis) {
            const numBubbles = Math.min(bubbleEmojis.length, 5);
            
            for (let i = 0; i < numBubbles; i++) {
                setTimeout(() => {
                    const bubble = document.createElement('div');
                    bubble.className = 'reaction-bubble';
                    bubble.textContent = bubbleEmojis[Math.floor(Math.random() * bubbleEmojis.length)];
                    
                    // موضع عشوائي حول الرسالة
                    const rect = messageElement.getBoundingClientRect();
                    const randomX = Math.random() * 100 - 50; // من -50 إلى 50
                    const randomY = Math.random() * 30 - 15; // من -15 إلى 15
                    
                    bubble.style.left = (rect.width / 2 + randomX) + 'px';
                    bubble.style.top = (rect.height / 2 + randomY) + 'px';
                    
                    messageElement.appendChild(bubble);
                    
                    // إزالة الفقاعة بعد انتهاء الحركة
                    setTimeout(() => {
                        if (bubble.parentNode) {
                            bubble.parentNode.removeChild(bubble);
                        }
                    }, 2000);
                }, i * 200); // تأخير بين الفقاعات
            }
        }

        // إظهار إشعار تفاعلي
        function showInteractiveNotification(word, effect) {
            const messages = {
                laugh: `😂 هههههه! كلمة "${word}" جعلت الرسالة تضحك!`,
                love: `❤️ أووه! كلمة "${word}" ملأت الرسالة بالحب!`,
                angry: `😡 أوه لا! كلمة "${word}" جعلت الرسالة غاضبة!`,
                sad: `😢 أوه... كلمة "${word}" جعلت الرسالة حزينة`,
                wow: `🤩 واو! كلمة "${word}" أبهرت الرسالة!`,
                party: `🎉 يا هلا! كلمة "${word}" بدأت الاحتفال!`,
                sleep: `😴 زززز... كلمة "${word}" جعلت الرسالة نعسانة`,
                food: `😋 يم يم! كلمة "${word}" جعلت الرسالة جائعة!`
            };
            
            const message = messages[effect] || `✨ كلمة "${word}" جعلت الرسالة تتفاعل!`;
            showNotification(message);
        }

        // إضافة رسالة تفاعلية تجريبية
        function addInteractiveTestMessage() {
            if (!currentChat) {
                showNotification('يرجى اختيار محادثة أولاً!', 'error');
                return;
            }
            
            const testMessages = [
                'ههههههه هذا مضحك جداً! 😂',
                'أحبك كثيراً يا حبيبي ❤️',
                'واو! هذا رائع ومذهل! 🤩',
                'مبروك على النجاح! 🎉',
                'أنا جائع جداً، أريد طعام 🍕',
                'أنا نعسان وتعبان 😴',
                'أنا غاضب وزعلان منك! 😡',
                'أنا حزين جداً اليوم 😢'
            ];
            
            const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
            
            const testMessage = {
                id: Date.now(),
                text: randomMessage,
                sent: true,
                time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now()
            };
            
            if (!messages[currentChat.id]) {
                messages[currentChat.id] = [];
            }
            
            messages[currentChat.id].push(testMessage);
            loadMessages(currentChat.id);
            
            showNotification('تم إضافة رسالة تفاعلية! اضغط عليها لترى السحر! ✨');
        }

        // إرسال رسالة
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (!text || !currentChat) {
                if (!currentChat) {
                    showNotification('يرجى اختيار محادثة أولاً!', 'error');
                }
                return;
            }
            
            const newMessage = {
                id: Date.now(),
                text: text,
                sent: true,
                time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })
            };
            
            if (!messages[currentChat.id]) {
                messages[currentChat.id] = [];
            }
            
            messages[currentChat.id].push(newMessage);
            loadMessages(currentChat.id);
            
            messageInput.value = '';
            adjustTextareaHeight(messageInput);
            
            // محاكاة رد تلقائي
            setTimeout(() => {
                const autoReply = {
                    id: Date.now() + 1,
                    text: 'شكراً لك على الرسالة! 😊',
                    sent: false,
                    time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })
                };
                messages[currentChat.id].push(autoReply);
                loadMessages(currentChat.id);
            }, 1000);
        }

        // التعامل مع الضغط على Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // تعديل ارتفاع منطقة النص
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // تبديل التبويبات
        function switchTab(tabName) {
            // إزالة الفئة النشطة من جميع الأزرار والمحتوى
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // إضافة الفئة النشطة للتبويب المحدد
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.querySelector(`[data-content="${tabName}"]`).classList.add('active');
        }

        // البحث في جهات الاتصال
        function searchContacts(query) {
            const contactItems = document.querySelectorAll('.contact-item');
            contactItems.forEach(item => {
                const name = item.querySelector('.font-semibold').textContent.toLowerCase();
                if (name.includes(query.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // عرض الإشعارات
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 transform translate-x-full transition-transform duration-300 ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // === وظائف نظام النجوم ===
        
        // عرض نافذة التقييم
        function showRatingPopup(starRatingElement, messageId) {
            // إزالة أي نافذة تقييم موجودة
            const existingPopup = document.querySelector('.rating-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // إنشاء نافذة التقييم
            const popup = document.createElement('div');
            popup.className = 'rating-popup';
            
            const stars = [];
            for (let i = 1; i <= 5; i++) {
                stars.push(`<span class="star empty" data-rating="${i}" onclick="rateMessage(${messageId}, ${i})">⭐</span>`);
            }
            
            popup.innerHTML = stars.join('');
            
            // إضافة تأثيرات التمرير للنجوم في النافذة
            popup.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('star')) {
                    const rating = parseInt(e.target.getAttribute('data-rating'));
                    const popupStars = popup.querySelectorAll('.star');
                    
                    popupStars.forEach((star, index) => {
                        if (index < rating) {
                            star.classList.remove('empty');
                            star.classList.add('filled');
                        } else {
                            star.classList.remove('filled');
                            star.classList.add('empty');
                        }
                    });
                }
            });
            
            popup.addEventListener('mouseleave', function() {
                const popupStars = popup.querySelectorAll('.star');
                popupStars.forEach(star => {
                    star.classList.remove('filled');
                    star.classList.add('empty');
                });
            });
            
            starRatingElement.appendChild(popup);
            
            // إظهار النافذة
            setTimeout(() => {
                popup.classList.add('show');
            }, 10);
            
            // إخفاء النافذة عند النقر خارجها
            setTimeout(() => {
                document.addEventListener('click', function hidePopup(e) {
                    if (!popup.contains(e.target) && !starRatingElement.contains(e.target)) {
                        popup.classList.remove('show');
                        setTimeout(() => {
                            if (popup.parentNode) {
                                popup.parentNode.removeChild(popup);
                            }
                        }, 300);
                        document.removeEventListener('click', hidePopup);
                    }
                });
            }, 100);
        }
        
        // تقييم الرسالة
        function rateMessage(messageId, rating) {
            if (!currentChat) return;
            
            // العثور على الرسالة وتحديث التقييم
            const message = messages[currentChat.id].find(msg => msg.id === messageId);
            if (message) {
                const oldRating = message.rating || 0;
                message.rating = rating;
                message.ratingCount = (message.ratingCount || 0) + 1;
                
                // تحديث عرض النجوم
                updateStarDisplay(messageId, rating, message.ratingCount);
                
                // تأثيرات بصرية
                createStarBurstEffect(messageId, rating);
                
                // رسائل التقييم المختلفة
                const ratingMessages = {
                    1: 'تقييم ضعيف! 😕 ربما المرة القادمة أفضل',
                    2: 'تقييم مقبول 😐 يمكن تحسينه',
                    3: 'تقييم جيد! 😊 استمر هكذا',
                    4: 'تقييم ممتاز! 😍 رسالة رائعة',
                    5: 'تقييم مثالي! 🤩 رسالة أسطورية!'
                };
                
                showNotification(ratingMessages[rating]);
                
                // إخفاء نافذة التقييم
                const popup = document.querySelector('.rating-popup');
                if (popup) {
                    popup.classList.remove('show');
                    setTimeout(() => {
                        if (popup.parentNode) {
                            popup.parentNode.removeChild(popup);
                        }
                    }, 300);
                }
                
                // اهتزاز خفيف
                if (navigator.vibrate) {
                    navigator.vibrate([50, 50, 50]);
                }
            }
        }
        
        // تحديث عرض النجوم
        function updateStarDisplay(messageId, rating, ratingCount) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            const starRating = messageElement.querySelector('.star-rating');
            if (!starRating) return;
            
            // تحديث النجوم
            const stars = starRating.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('empty');
                    star.classList.add('filled');
                } else {
                    star.classList.remove('filled');
                    star.classList.add('empty');
                }
            });
            
            // تحديث عداد التقييمات
            let countElement = starRating.querySelector('.rating-count');
            if (ratingCount > 0) {
                if (!countElement) {
                    countElement = document.createElement('span');
                    countElement.className = 'rating-count';
                    starRating.insertBefore(countElement, starRating.firstChild);
                }
                countElement.textContent = ratingCount;
            }
            
            // تأثير الاحتفال
            starRating.classList.add('rating-celebration');
            setTimeout(() => {
                starRating.classList.remove('rating-celebration');
            }, 800);
        }
        
        // تأثير انفجار النجوم
        function createStarBurstEffect(messageId, rating) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            const starRating = messageElement.querySelector('.star-rating');
            if (!starRating) return;
            
            // إنشاء نجوم متفجرة بناءً على التقييم
            for (let i = 0; i < rating; i++) {
                setTimeout(() => {
                    const burstStar = document.createElement('div');
                    burstStar.className = 'star-burst';
                    burstStar.textContent = '⭐';
                    
                    // موضع عشوائي حول منطقة النجوم
                    const rect = starRating.getBoundingClientRect();
                    const randomX = Math.random() * 60 - 30;
                    const randomY = Math.random() * 60 - 30;
                    
                    burstStar.style.left = (rect.width / 2 + randomX) + 'px';
                    burstStar.style.top = (rect.height / 2 + randomY) + 'px';
                    
                    starRating.appendChild(burstStar);
                    
                    // إزالة النجمة بعد انتهاء الحركة
                    setTimeout(() => {
                        if (burstStar.parentNode) {
                            burstStar.parentNode.removeChild(burstStar);
                        }
                    }, 1000);
                }, i * 100);
            }
        }
        
        // تحديث إضافة رسالة تفاعلية لتشمل النجوم والإيموجي الطائرة
        function addInteractiveTestMessage() {
            if (!currentChat) {
                showNotification('يرجى اختيار محادثة أولاً!', 'error');
                return;
            }
            
            const testMessages = [
                'ههههههه هذا مضحك جداً! 😂🤣',
                'أحبك كثيراً يا حبيبي ❤️💕',
                'واو! هذا رائع ومذهل! 🤩✨',
                'مبروك على النجاح! 🎉🎊',
                'هذا رائع جداً! 🔥💯',
                'أنت الأفضل! ⭐🌟',
                'يا هلا وغلا! 🥳🎉',
                'أحبك من كل قلبي! 😍❤️💖'
            ];
            
            const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
            
            const testMessage = {
                id: Date.now(),
                text: randomMessage,
                sent: true,
                time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                rating: 0,
                ratingCount: 0
            };
            
            if (!messages[currentChat.id]) {
                messages[currentChat.id] = [];
            }
            
            messages[currentChat.id].push(testMessage);
            loadMessages(currentChat.id);
            
            // إطلاق الإيموجي الطائرة من الرسالة الجديدة
            setTimeout(() => {
                const messageElement = document.querySelector(`[data-message-id="${testMessage.id}"]`);
                if (messageElement) {
                    detectAndLaunchEmojis(randomMessage, messageElement);
                }
            }, 200);
            
            showNotification('تم إضافة رسالة تفاعلية! شاهد الإيموجي تطير! 🚀⭐');
        }

        // === وظائف الإيموجي الطائرة ===
        
        // قاموس الإيموجي الطائرة وحركاتها
        const flyingEmojis = {
            '😂': { type: 'laugh', animations: ['fly-bounce', 'fly-zigzag'], trail: true },
            '🤣': { type: 'laugh', animations: ['fly-bounce', 'fly-spiral'], trail: true },
            '😆': { type: 'laugh', animations: ['fly-straight', 'fly-bounce'], trail: false },
            '❤️': { type: 'heart', animations: ['fly-float', 'fly-spiral'], trail: false },
            '💕': { type: 'heart', animations: ['fly-float', 'fly-bounce'], trail: false },
            '💖': { type: 'heart', animations: ['fly-spiral', 'fly-float'], trail: false },
            '💗': { type: 'heart', animations: ['fly-bounce', 'fly-float'], trail: false },
            '🔥': { type: 'fire', animations: ['fly-straight', 'fly-zigzag'], trail: true },
            '⭐': { type: 'star', animations: ['fly-spiral', 'fly-float'], trail: false },
            '🌟': { type: 'star', animations: ['fly-bounce', 'fly-spiral'], trail: false },
            '✨': { type: 'star', animations: ['fly-float', 'fly-straight'], trail: false },
            '🎉': { type: 'party', animations: ['fly-bounce', 'fly-zigzag'], trail: true },
            '🎊': { type: 'party', animations: ['fly-spiral', 'fly-bounce'], trail: true },
            '🥳': { type: 'party', animations: ['fly-zigzag', 'fly-spiral'], trail: false },
            '😍': { type: 'heart', animations: ['fly-float', 'fly-spiral'], trail: false },
            '🤩': { type: 'star', animations: ['fly-bounce', 'fly-float'], trail: false },
            '💯': { type: 'fire', animations: ['fly-straight', 'fly-bounce'], trail: true }
        };
        
        // البحث عن الإيموجي في النص وإطلاقها
        function detectAndLaunchEmojis(text, sourceElement) {
            // البحث عن جميع الإيموجي في النص
            const emojiRegex = /(😂|🤣|😆|❤️|💕|💖|💗|🔥|⭐|🌟|✨|🎉|🎊|🥳|😍|🤩|💯)/g;
            const foundEmojis = text.match(emojiRegex);
            
            if (foundEmojis && foundEmojis.length > 0) {
                // إطلاق كل إيموجي بتأخير مختلف
                foundEmojis.forEach((emoji, index) => {
                    setTimeout(() => {
                        launchFlyingEmoji(emoji, sourceElement);
                    }, index * 300); // تأخير 300ms بين كل إيموجي
                });
                
                // إشعار تفاعلي
                if (foundEmojis.length > 1) {
                    showNotification(`🚀 واو! ${foundEmojis.length} إيموجي تطير في الشاشة!`);
                } else {
                    showNotification(`✨ إيموجي ${foundEmojis[0]} تطير في الشاشة!`);
                }
            }
        }
        
        // إطلاق إيموجي طائرة
        function launchFlyingEmoji(emoji, sourceElement) {
            const emojiConfig = flyingEmojis[emoji];
            if (!emojiConfig) return;
            
            // إنشاء عنصر الإيموجي الطائرة
            const flyingEmoji = document.createElement('div');
            flyingEmoji.className = `flying-emoji emoji-${emojiConfig.type}`;
            flyingEmoji.textContent = emoji;
            
            // إضافة تأثير الذيل إذا كان مطلوباً
            if (emojiConfig.trail) {
                flyingEmoji.classList.add('emoji-trail');
                flyingEmoji.setAttribute('data-emoji', emoji);
            }
            
            // تحديد موضع البداية (من الرسالة)
            const rect = sourceElement.getBoundingClientRect();
            flyingEmoji.style.left = (rect.left + rect.width / 2) + 'px';
            flyingEmoji.style.top = (rect.top + rect.height / 2) + 'px';
            
            // اختيار حركة عشوائية
            const randomAnimation = emojiConfig.animations[Math.floor(Math.random() * emojiConfig.animations.length)];
            flyingEmoji.classList.add(randomAnimation);
            
            // إضافة الإيموجي للصفحة
            document.body.appendChild(flyingEmoji);
            
            // إنشاء إيموجي إضافية للتأثير المضاعف
            if (Math.random() > 0.7) { // 30% احتمال
                setTimeout(() => {
                    createEmojiClone(emoji, sourceElement, emojiConfig);
                }, 500);
            }
            
            // إزالة الإيموجي بعد انتهاء الحركة
            const animationDuration = getAnimationDuration(randomAnimation);
            setTimeout(() => {
                if (flyingEmoji.parentNode) {
                    flyingEmoji.parentNode.removeChild(flyingEmoji);
                }
            }, animationDuration);
        }
        
        // إنشاء نسخة إضافية من الإيموجي
        function createEmojiClone(emoji, sourceElement, emojiConfig) {
            const clone = document.createElement('div');
            clone.className = `flying-emoji emoji-${emojiConfig.type}`;
            clone.textContent = emoji;
            clone.style.fontSize = '30px'; // أصغر قليلاً
            clone.style.opacity = '0.8';
            
            const rect = sourceElement.getBoundingClientRect();
            clone.style.left = (rect.left + rect.width / 2 + Math.random() * 100 - 50) + 'px';
            clone.style.top = (rect.top + rect.height / 2 + Math.random() * 50 - 25) + 'px';
            
            // حركة مختلفة للنسخة
            const animations = emojiConfig.animations.filter(anim => !clone.classList.contains(anim));
            const randomAnimation = animations[Math.floor(Math.random() * animations.length)] || 'fly-float';
            clone.classList.add(randomAnimation);
            
            document.body.appendChild(clone);
            
            const animationDuration = getAnimationDuration(randomAnimation);
            setTimeout(() => {
                if (clone.parentNode) {
                    clone.parentNode.removeChild(clone);
                }
            }, animationDuration);
        }
        
        // الحصول على مدة الحركة
        function getAnimationDuration(animationType) {
            const durations = {
                'fly-straight': 4000,
                'fly-bounce': 5000,
                'fly-spiral': 6000,
                'fly-zigzag': 5000,
                'fly-float': 7000
            };
            return durations[animationType] || 5000;
        }
        
        // إطلاق إيموجي عشوائية (للاختبار)
        function launchRandomEmoji() {
            const emojis = Object.keys(flyingEmojis);
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            // إنشاء عنصر وهمي كمصدر
            const dummySource = document.createElement('div');
            dummySource.style.position = 'fixed';
            dummySource.style.left = '50%';
            dummySource.style.top = '50%';
            dummySource.style.width = '1px';
            dummySource.style.height = '1px';
            document.body.appendChild(dummySource);
            
            launchFlyingEmoji(randomEmoji, dummySource);
            
            setTimeout(() => {
                if (dummySource.parentNode) {
                    dummySource.parentNode.removeChild(dummySource);
                }
            }, 100);
        }
        
        // إطلاق عاصفة من الإيموجي
        function launchEmojiStorm(emoji, count = 5) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    launchRandomEmoji();
                }, i * 200);
            }
            showNotification(`🌪️ عاصفة من ${emoji}! استمتع بالعرض!`);
        }

        // تحديث إرسال الرسائل لتشمل النجوم والإيموجي الطائرة
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (!text || !currentChat) {
                if (!currentChat) {
                    showNotification('يرجى اختيار محادثة أولاً!', 'error');
                }
                return;
            }
            
            const newMessage = {
                id: Date.now(),
                text: text,
                sent: true,
                time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }),
                rating: 0,
                ratingCount: 0
            };
            
            if (!messages[currentChat.id]) {
                messages[currentChat.id] = [];
            }
            
            messages[currentChat.id].push(newMessage);
            loadMessages(currentChat.id);
            
            // البحث عن الإيموجي وإطلاقها
            setTimeout(() => {
                const messageElement = document.querySelector(`[data-message-id="${newMessage.id}"]`);
                if (messageElement) {
                    detectAndLaunchEmojis(text, messageElement);
                }
            }, 100);
            
            messageInput.value = '';
            adjustTextareaHeight(messageInput);
            
            // محاكاة رد تلقائي مع تقييم عشوائي
            setTimeout(() => {
                const autoReplies = [
                    'شكراً لك على الرسالة! 😊',
                    'رائع! 🔥',
                    'ههههه 😂',
                    'أحبك أيضاً! ❤️',
                    'واو مذهل! 🤩',
                    'يا هلا! 🎉'
                ];
                
                const randomReply = autoReplies[Math.floor(Math.random() * autoReplies.length)];
                
                const autoReply = {
                    id: Date.now() + 1,
                    text: randomReply,
                    sent: false,
                    time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }),
                    rating: Math.floor(Math.random() * 3) + 3,
                    ratingCount: Math.floor(Math.random() * 5) + 1
                };
                messages[currentChat.id].push(autoReply);
                loadMessages(currentChat.id);
                
                // إطلاق إيموجي من الرد التلقائي أيضاً
                setTimeout(() => {
                    const replyElement = document.querySelector(`[data-message-id="${autoReply.id}"]`);
                    if (replyElement) {
                        detectAndLaunchEmojis(randomReply, replyElement);
                    }
                }, 100);
            }, 1500);
        }

        // === وظائف نظام الهدايا ===
        
        // عرض قائمة الهدايا
        function showGiftMenu() {
            if (!currentChat) {
                showNotification('يرجى اختيار محادثة أولاً!', 'error');
                return;
            }
            
            const giftMenu = document.getElementById('giftMenu');
            giftMenu.classList.add('show');
            
            // إخفاء القائمة عند النقر خارجها
            setTimeout(() => {
                document.addEventListener('click', function hideGiftMenu(e) {
                    if (!giftMenu.contains(e.target) && !e.target.closest('[onclick="showGiftMenu()"]')) {
                        giftMenu.classList.remove('show');
                        document.removeEventListener('click', hideGiftMenu);
                    }
                });
            }, 100);
        }
        
        // إرسال هدية
        function sendGift(emoji, name, type) {
            if (!currentChat) {
                showNotification('يرجى اختيار محادثة أولاً!', 'error');
                return;
            }
            
            // إخفاء قائمة الهدايا
            document.getElementById('giftMenu').classList.remove('show');
            
            // إنشاء رسالة الهدية
            const giftMessage = {
                id: Date.now(),
                text: `🎁 هدية: ${name} ${emoji}`,
                sent: true,
                time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }),
                isGift: true,
                giftEmoji: emoji,
                giftName: name,
                giftType: type,
                rating: 0,
                ratingCount: 0
            };
            
            if (!messages[currentChat.id]) {
                messages[currentChat.id] = [];
            }
            
            messages[currentChat.id].push(giftMessage);
            loadMessages(currentChat.id);
            
            // تأثيرات إرسال الهدية
            createGiftSendEffect(emoji);
            showNotification(`تم إرسال ${name} ${emoji} بنجاح!`);
            
            // محاكاة استلام الهدية من الطرف الآخر
            setTimeout(() => {
                receiveGift(emoji, name, type);
            }, 2000);
        }
        
        // استلام هدية
        function receiveGift(emoji, name, type) {
            if (!currentChat) return;
            
            // إنشاء رسالة استلام الهدية
            const receivedGift = {
                id: Date.now(),
                text: `شكراً لك على ${name} الجميلة! ${emoji}`,
                sent: false,
                time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }),
                isReceivedGift: true,
                giftEmoji: emoji,
                giftName: name,
                giftType: type,
                rating: 5,
                ratingCount: 1
            };
            
            messages[currentChat.id].push(receivedGift);
            loadMessages(currentChat.id);
            
            // تأثيرات استلام الهدية
            setTimeout(() => {
                const messageElement = document.querySelector(`[data-message-id="${receivedGift.id}"]`);
                if (messageElement) {
                    createGiftOpeningEffect(messageElement, emoji, name, type);
                }
            }, 100);
            
            // إشعار استلام الهدية
            showGiftNotification(emoji, name, currentChat.name);
        }
        
        // تأثيرات إرسال الهدية
        function createGiftSendEffect(emoji) {
            // إنشاء جزيئات الهدية
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'gift-particle';
                    particle.textContent = emoji;
                    
                    // موضع عشوائي حول وسط الشاشة
                    particle.style.left = (window.innerWidth / 2 + Math.random() * 200 - 100) + 'px';
                    particle.style.top = (window.innerHeight / 2 + Math.random() * 200 - 100) + 'px';
                    
                    document.body.appendChild(particle);
                    
                    // إزالة الجزيئة بعد انتهاء الحركة
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 3000);
                }, i * 100);
            }
            
            // اهتزاز خفيف
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100, 50, 200]);
            }
        }
        
        // تأثيرات فتح الهدية
        function createGiftOpeningEffect(messageElement, emoji, name, type) {
            // إضافة تأثير الفتح
            messageElement.classList.add('gift-opening');
            
            // إنشاء جزيئات حول الرسالة
            const rect = messageElement.getBoundingClientRect();
            const particles = ['✨', '🎊', '🎉', '💫', '⭐'];
            
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'gift-particle';
                    particle.textContent = particles[Math.floor(Math.random() * particles.length)];
                    
                    // موضع عشوائي حول الرسالة
                    particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                    particle.style.top = (rect.top + Math.random() * rect.height) + 'px';
                    
                    document.body.appendChild(particle);
                    
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 3000);
                }, i * 150);
            }
            
            // إزالة تأثير الفتح
            setTimeout(() => {
                messageElement.classList.remove('gift-opening');
            }, 2000);
        }
        
        // إشعار استلام الهدية
        function showGiftNotification(emoji, name, senderName) {
            const notification = document.createElement('div');
            notification.className = 'gift-notification';
            
            notification.innerHTML = `
                <div class="gift-emoji-huge">${emoji}</div>
                <h2>🎁 هدية جديدة!</h2>
                <p>لقد استلمت <strong>${name}</strong> من <strong>${senderName}</strong></p>
                <button onclick="closeGiftNotification(this)">رائع! 😍</button>
            `;
            
            document.body.appendChild(notification);
            
            // إزالة الإشعار تلقائياً بعد 5 ثوان
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
            
            // اهتزاز قوي
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 300]);
            }
        }
        
        // إغلاق إشعار الهدية
        function closeGiftNotification(button) {
            const notification = button.closest('.gift-notification');
            if (notification) {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }
        
        // تحديث تحميل الرسائل لدعم الهدايا
        function loadMessages(contactId) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = '';
            
            if (!messages[contactId]) {
                messages[contactId] = [
                    { id: 1, text: 'مرحباً! كيف حالك؟', sent: false, time: '10:30', rating: 0, ratingCount: 0 },
                    { id: 2, text: 'أهلاً وسهلاً! بخير والحمد لله ههههه 😂', sent: true, time: '10:32', rating: 4, ratingCount: 3 },
                    { id: 3, text: 'ما أخبارك؟ أحبك كثيراً ❤️', sent: false, time: '10:33', rating: 5, ratingCount: 2 },
                    { id: 4, text: 'واو! هذا رائع جداً 🤩', sent: true, time: '10:34', rating: 3, ratingCount: 1 },
                    { id: 5, text: 'أنا جائع جداً 🍕', sent: false, time: '10:35', rating: 2, ratingCount: 1 }
                ];
            }
            
            messages[contactId].forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.sent ? 'sent' : 'received'}`;
                messageElement.setAttribute('data-message-id', message.id);
                
                if (message.isGift || message.isReceivedGift) {
                    // عرض رسائل الهدايا
                    const giftClass = message.giftType ? `gift-${message.giftType}` : '';
                    messageElement.innerHTML = `
                        <div class="message-bubble gift-message ${giftClass}" style="max-width: 90%;">
                            <div class="gift-content">
                                <span class="gift-emoji-large">${message.giftEmoji}</span>
                                <div class="gift-text">${message.isGift ? 'أرسلت' : 'استلمت'} ${message.giftName}</div>
                                <div class="gift-sender">${message.isGift ? 'إليك' : `من ${currentChat.name}`}</div>
                            </div>
                            <div class="text-xs opacity-70 mt-2">${message.time}</div>
                            ${message.isReceivedGift ? createStarRating(message.rating || 0, message.ratingCount || 0, message.id) : ''}
                        </div>
                    `;
                } else {
                    // عرض الرسائل العادية مع التفاعل والنجوم
                    const processedText = makeTextInteractive(message.text);
                    const starRating = createStarRating(message.rating || 0, message.ratingCount || 0, message.id);
                    
                    messageElement.innerHTML = `
                        <div class="message-bubble interactive-message" onclick="handleMessageClick(this, '${message.text.replace(/'/g, "\\'")}')">
                            ${processedText}
                            <div class="text-xs opacity-70 mt-1">${message.time}</div>
                            ${starRating}
                        </div>
                    `;
                }
                
                messageContainer.appendChild(messageElement);
            });
            
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // === وظائف نظام الذكريات اليومية ===
        
        // متغيرات الذكريات
        let dailyMemories = JSON.parse(localStorage.getItem('dailyMemories') || '[]');
        let selectedMood = null;
        let selectedMoodEmoji = null;
        let selectedMoodLabel = null;
        
        // عرض نافذة الذكريات اليومية
        function showDailyMemoryPrompt() {
            const popup = document.getElementById('memoryPopup');
            const dateElement = document.getElementById('memoryDate');
            
            // تحديث التاريخ
            const today = new Date();
            const arabicDate = today.toLocaleDateString('ar-SA', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            dateElement.textContent = arabicDate;
            
            // التحقق من وجود ذكرى لليوم
            const todayKey = today.toDateString();
            const existingMemory = dailyMemories.find(memory => memory.date === todayKey);
            
            if (existingMemory) {
                // إذا كانت هناك ذكرى لليوم، اعرضها للتعديل
                document.getElementById('memoryText').value = existingMemory.text;
                selectMoodByEmoji(existingMemory.mood);
                document.querySelector('.memory-question').textContent = 'تعديل ذكرى اليوم 📝';
            } else {
                // إذا لم تكن هناك ذكرى، ابدأ جديدة
                document.getElementById('memoryText').value = '';
                clearMoodSelection();
                document.querySelector('.memory-question').textContent = 'كيف كان يومك اليوم؟ 😊';
            }
            
            popup.classList.add('show');
            
            // تركيز على منطقة النص
            setTimeout(() => {
                document.getElementById('memoryText').focus();
            }, 500);
        }
        
        // اختيار المزاج
        function selectMood(element, emoji, label) {
            // إزالة التحديد من جميع الخيارات
            document.querySelectorAll('.mood-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // تحديد الخيار المختار
            element.classList.add('selected');
            selectedMood = element;
            selectedMoodEmoji = emoji;
            selectedMoodLabel = label;
            
            // تأثير بصري
            createMemoryParticles(element, [emoji, '✨', '💫']);
            
            // اهتزاز خفيف
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        // اختيار المزاج بالإيموجي (للتعديل)
        function selectMoodByEmoji(emoji) {
            const moodOptions = document.querySelectorAll('.mood-option');
            moodOptions.forEach(option => {
                const moodEmoji = option.querySelector('.mood-emoji').textContent;
                if (moodEmoji === emoji) {
                    const label = option.querySelector('.mood-label').textContent;
                    selectMood(option, emoji, label);
                }
            });
        }
        
        // مسح تحديد المزاج
        function clearMoodSelection() {
            document.querySelectorAll('.mood-option').forEach(option => {
                option.classList.remove('selected');
            });
            selectedMood = null;
            selectedMoodEmoji = null;
            selectedMoodLabel = null;
        }
        
        // حفظ الذكرى
        function saveMemory() {
            const memoryText = document.getElementById('memoryText').value.trim();
            
            if (!memoryText) {
                showNotification('يرجى كتابة شيء عن يومك! 📝', 'error');
                return;
            }
            
            if (!selectedMoodEmoji) {
                showNotification('يرجى اختيار مزاجك اليوم! 😊', 'error');
                return;
            }
            
            const today = new Date();
            const todayKey = today.toDateString();
            
            // إنشاء أو تحديث الذكرى
            const memory = {
                id: Date.now(),
                date: todayKey,
                dateFormatted: today.toLocaleDateString('ar-SA', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }),
                mood: selectedMoodEmoji,
                moodLabel: selectedMoodLabel,
                text: memoryText,
                timestamp: today.getTime(),
                wordCount: memoryText.split(' ').length
            };
            
            // البحث عن ذكرى موجودة لليوم
            const existingIndex = dailyMemories.findIndex(m => m.date === todayKey);
            
            if (existingIndex !== -1) {
                // تحديث الذكرى الموجودة
                dailyMemories[existingIndex] = memory;
                showNotification('تم تحديث ذكرى اليوم! ✨');
            } else {
                // إضافة ذكرى جديدة
                dailyMemories.unshift(memory);
                showNotification('تم حفظ ذكرى اليوم! 🎉');
            }
            
            // حفظ في التخزين المحلي
            localStorage.setItem('dailyMemories', JSON.stringify(dailyMemories));
            
            // تأثيرات الاحتفال
            createMemoryCelebration();
            
            // إغلاق النافذة
            setTimeout(() => {
                closeMemoryPopup();
            }, 1500);
        }
        
        // إغلاق نافذة الذكريات
        function closeMemoryPopup() {
            const popup = document.getElementById('memoryPopup');
            popup.classList.remove('show');
            
            // مسح البيانات
            setTimeout(() => {
                document.getElementById('memoryText').value = '';
                clearMoodSelection();
            }, 500);
        }
        
        // عرض صفحة الذكريات
        function showMemoriesPage() {
            const page = document.getElementById('memoriesPage');
            page.classList.add('show');
            
            // تحديث الإحصائيات
            updateMemoriesStats();
            
            // تحميل الذكريات
            loadMemoriesGrid();
        }
        
        // إغلاق صفحة الذكريات
        function closeMemoriesPage() {
            const page = document.getElementById('memoriesPage');
            page.classList.remove('show');
        }
        
        // تحديث إحصائيات الذكريات
        function updateMemoriesStats() {
            const totalMemories = dailyMemories.length;
            const happyDays = dailyMemories.filter(memory => 
                ['😊', '😍', '🥳', '😄', '🤩'].includes(memory.mood)
            ).length;
            
            // حساب الأيام المتتالية
            let currentStreak = 0;
            const today = new Date();
            let checkDate = new Date(today);
            
            for (let i = 0; i < 30; i++) { // فحص آخر 30 يوم
                const dateKey = checkDate.toDateString();
                const hasMemory = dailyMemories.some(memory => memory.date === dateKey);
                
                if (hasMemory) {
                    currentStreak++;
                } else {
                    break;
                }
                
                checkDate.setDate(checkDate.getDate() - 1);
            }
            
            // تحديث العرض
            document.getElementById('totalMemories').textContent = totalMemories;
            document.getElementById('happyDays').textContent = happyDays;
            document.getElementById('currentStreak').textContent = currentStreak;
        }
        
        // تحميل شبكة الذكريات
        function loadMemoriesGrid() {
            const grid = document.getElementById('memoriesGrid');
            grid.innerHTML = '';
            
            if (dailyMemories.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 60px; margin-bottom: 20px;">📖</div>
                        <h3 style="margin: 0 0 10px 0; color: var(--primary-color);">لا توجد ذكريات بعد</h3>
                        <p style="margin: 0;">ابدأ بكتابة ذكرى يومك الأولى!</p>
                        <button onclick="closeMemoriesPage(); showDailyMemoryPrompt();" 
                                style="margin-top: 20px; background: var(--primary-gradient); color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer;">
                            اكتب ذكرى اليوم ✨
                        </button>
                    </div>
                `;
                return;
            }
            
            dailyMemories.forEach(memory => {
                const memoryElement = document.createElement('div');
                memoryElement.className = 'memory-item';
                
                // تحديد لون الخلفية بناءً على المزاج
                const moodColors = {
                    '😊': 'linear-gradient(135deg, #ffeaa7, #fdcb6e)',
                    '😢': 'linear-gradient(135deg, #a8e6cf, #74b9ff)',
                    '😴': 'linear-gradient(135deg, #ddd6fe, #c084fc)',
                    '😍': 'linear-gradient(135deg, #ff7675, #fd79a8)',
                    '😤': 'linear-gradient(135deg, #ff6b6b, #ee5a52)',
                    '🤔': 'linear-gradient(135deg, #81ecec, #00cec9)'
                };
                
                const bgColor = moodColors[memory.mood] || 'linear-gradient(135deg, #f8f9fa, #e9ecef)';
                
                memoryElement.innerHTML = `
                    <div class="memory-item-header">
                        <div class="memory-item-date">${memory.dateFormatted}</div>
                        <div class="memory-item-mood">${memory.mood}</div>
                    </div>
                    <div class="memory-item-text">${memory.text}</div>
                    <div class="memory-item-footer">
                        <span>المزاج: ${memory.moodLabel}</span>
                        <span>${memory.wordCount} كلمة</span>
                    </div>
                `;
                
                // إضافة لون الخلفية
                memoryElement.style.background = bgColor;
                
                grid.appendChild(memoryElement);
            });
        }
        
        // إنشاء جزيئات الذكريات
        function createMemoryParticles(sourceElement, particles) {
            const rect = sourceElement.getBoundingClientRect();
            
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'memory-particle';
                    particle.textContent = particles[Math.floor(Math.random() * particles.length)];
                    
                    // موضع عشوائي حول العنصر
                    particle.style.left = (rect.left + rect.width / 2 + Math.random() * 60 - 30) + 'px';
                    particle.style.top = (rect.top + rect.height / 2 + Math.random() * 60 - 30) + 'px';
                    
                    document.body.appendChild(particle);
                    
                    // إزالة الجزيئة بعد انتهاء الحركة
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 3000);
                }, i * 100);
            }
        }
        
        // إنشاء احتفال الذكريات
        function createMemoryCelebration() {
            const memoryCard = document.querySelector('.memory-card');
            memoryCard.classList.add('memory-celebration');
            
            // جزيئات احتفالية
            const celebrationParticles = ['🎉', '✨', '🌟', '💫', '🎊', '🥳'];
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'memory-particle';
                    particle.textContent = celebrationParticles[Math.floor(Math.random() * celebrationParticles.length)];
                    
                    // موضع عشوائي حول البطاقة
                    particle.style.left = (window.innerWidth / 2 + Math.random() * 400 - 200) + 'px';
                    particle.style.top = (window.innerHeight / 2 + Math.random() * 300 - 150) + 'px';
                    
                    document.body.appendChild(particle);
                    
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 3000);
                }, i * 100);
            }
            
            // إزالة تأثير الاحتفال
            setTimeout(() => {
                memoryCard.classList.remove('memory-celebration');
            }, 1000);
            
            // اهتزاز قوي
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 300]);
            }
        }
        
        // فحص الذكريات اليومية (يتم استدعاؤها تلقائياً)
        function checkDailyMemoryReminder() {
            const now = new Date();
            const hour = now.getHours();
            
            // فحص في المساء (بين 6 مساءً و 11 مساءً)
            if (hour >= 18 && hour <= 23) {
                const todayKey = now.toDateString();
                const hasMemoryToday = dailyMemories.some(memory => memory.date === todayKey);
                
                if (!hasMemoryToday) {
                    // إظهار تذكير لطيف
                    setTimeout(() => {
                        showNotification('🌙 كيف كان يومك؟ لا تنس كتابة ذكرياتك!');
                        
                        // إظهار النافذة تلقائياً بعد 5 ثوان
                        setTimeout(() => {
                            if (confirm('هل تريد كتابة ذكرى اليوم الآن؟ 📝')) {
                                showDailyMemoryPrompt();
                            }
                        }, 5000);
                    }, 3000);
                }
            }
        }

        // تحميل البيانات عند بدء التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل واجهة جهات الاتصال
            loadContacts();
            
            // رسالة ترحيب
            showNotification('مرحباً بك في المرسال المتطور! 🚀');
            showNotification('اضغط على أي صديق لفتح المحادثة! 👆');
            showNotification('جرب نظام الهدايا الجديد! 🎁✨');
            showNotification('لا تنس كتابة ذكرياتك اليومية! 📖💭');
            
            // فحص تذكير الذكريات اليومية
            checkDailyMemoryReminder();
            
            // فحص كل ساعة
            setInterval(checkDailyMemoryReminder, 3600000); // كل ساعة
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'989ce14de4013415',t:'MTc1OTY2NjkwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
